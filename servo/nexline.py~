class NexModes(IntEnum):
    FULL_STEP = 0
    NANO_STEP = 1
    ANALOG = 2
    
class Nexline(object):

    CHANNEL = 1

    STEP_SIZE = 5. # um in mpd
    
    def __init__(self):
        self.pidevice = pipython.GCSDevice('E-712')
        try:
            #devices = self.pidevice.EnumerateUSB()
            #for i, device in enumerate(devices):
            #    print('{} - {}'.format(i, device))
            self.pidevice.ConnectUSB(serialnum='120009499')
            
            if not self.pidevice.connected:
                print('error at usb connection')
                self.stop()

            pipython.pitools.waitonready(self.pidevice)
    
            print('Nexline ID: ', self.pidevice.qIDN())
            print('Nexline Operating mode: ', self.pidevice.qSVO(self.CHANNEL)[self.CHANNEL])
            self.print_pos()
        except Exception as e:
            print(f'error during init: {e}')
            self.stop()

    def to_opd(self, mpd):
        """convert mpd to opd"""
        return mpd * 2 / np.cos(np.deg2rad(config.LASER_ANGLE))

    def to_mpd(self, opd):
        """convert opd to mpd"""
        return opd / 2 * np.cos(np.deg2rad(config.LASER_ANGLE))
        
    
    def stop(self):
        try:
            self.pidevice.close()
        except Exception as e:
            print('error at closing device')

    def _getval(self, answer):
        try:
            return next(iter(answer[self.CHANNEL].values()))
        except Exception as e:
            print(f'badly formatted answer: {e}')


    def get_pos(self):
        """return the Nexline encoded position
        """
        return self.pidevice.qPOS(self.CHANNEL)[self.CHANNEL]

    def print_pos(self):
        print(f'actual pos {self.get_pos()} um')
    
    def get_velocity(self):
        """
        return optical velocity in um/s
        """
        return self.to_opd(self._getval(self.pidevice.qSPA(self.CHANNEL, 0x07000204)))

    def print_velocity(self):
        print(f'actual optical velocity: {self.get_velocity()} um/s')
    
    def set_velocity(self, velocity=250):
        """
        set optical velocity in um/s
        """
        try:
            self.print_velocity()
            self.pidevice.CCL(1, 'advanced') # switch to high command level
            self.pidevice.SPA(self.CHANNEL, 0x07000204, float(self.to_mpd(velocity)))
            self.pidevice.CCL(0) # switch to low command level
            self.print_velocity()
            
        except Exception as e:
            print(f'error when setting velocity: {e}')

    def set_driving_mode(self, driving_mode: NexModes):
        print(f'switching driving mode to {driving_mode}')
        try:
            print(f'actual driving mode {self._getval(self.pidevice.qSPA(self.CHANNEL, 0x7001a00))}')
            self.pidevice.CCL(1, 'advanced') # switch to high command level
            self.pidevice.SPA(self.CHANNEL, 0x7001a00, int(driving_mode)) # piezowalk driving mode
            self.pidevice.CCL(0) # switch to low command level
            print(f'new driving mode {self._getval(self.pidevice.qSPA(self.CHANNEL, 0x7001a00))}')
            
        except Exception as e:
            print(f'error setting driving mode: {e}')


    def move(self, opd, relax=True):
        """optical path difference in nm
        
        relax: relax Nexline after move. Unsuitable for precise measurment of the nexline movement.
        """

        velocity = self.get_velocity() # um/s
        #step_size = self.pidevice.qSSA(self.CHANNEL)[self.CHANNEL] #um
        step_nb = self.to_mpd(opd) / 1e3 / self.STEP_SIZE

 
        print(f'moving at {velocity} um/s with a step size of {self.STEP_SIZE} for {opd} nm ({step_nb} steps)')
        #return
        self.print_pos()
        
        print(self.pidevice.qSSA(self.CHANNEL))
        startt = time.time()
        self.pidevice.OSM(self.CHANNEL, step_nb)
        pipython.pitools.waitonwalk(self.pidevice, self.CHANNEL)
        self.print_pos()
        if relax:
            self.pidevice.RNP(self.CHANNEL, 0)
        print(f'finished stepping in {time.time() - startt} s')

    
