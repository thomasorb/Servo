#!/usr/bin/env python3
import argparse
from .calib import run_calibration
from .run import run_program
from .logger import init_logging
import logging

def main():
    init_logging("DEBUG")
    logger = logging.getLogger(__name__)

    logger.info("CLI started")

    # Create top-level parser
    parser = argparse.ArgumentParser(
        prog="servo",
        description="Servo command-line tool with git-style subcommands (calib/run)"
    )

    parser.add_argument(
        "-v", "--verbosity",
        default="INFO",
        choices=["DEBUG", "INFO", "WARNING", "ERROR"],
        help="Set logging verbosity level."
    )

    # Subparsers (git-style)
    subparsers = parser.add_subparsers(dest="command", required=True)

    # --- calib subcommand ---
    calib_parser = subparsers.add_parser("calib", help="Run calibration mode")
    calib_parser.add_argument("-nc", "--nocam", action="store_true", help="Disable camera")
    calib_parser.add_argument("-nv", "--noviewer", action="store_true", help="Disable viewer")

    # --- run subcommand ---
    run_parser = subparsers.add_parser("run", help="Run main execution mode")
    run_parser.add_argument("-nc", "--nocam", action="store_true", help="Disable camera")
    run_parser.add_argument("-nv", "--noviewer", action="store_true", help="Disable viewer")

    args = parser.parse_args()

    # Initialize logging system
    init_logging(args.verbosity)

    logging.info(f"Selected command: {args.command}")
    logging.debug(f"Arguments: {args}")

    # Dispatch to subcommand handlers
    if args.command == "calib":
        run_calibration(args)
    elif args.command == "run":
        run_program(args)
