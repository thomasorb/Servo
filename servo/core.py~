import numpy as np
import logging

import config

global logger
logger = logging.getLogger(__name__)


class Worker(object):

    def __init__(self, data):

        self.data = data

from multiprocessing import shared_memory

class SharedData(object):

    def __init__(self):
        self.shms = dict()
        self.arrs = dict()
        
        self.add_array('IRCamera.last_frame', np.zeros(config.FULL_FRAME_SIZE, dtype=config.FRAME_DTYPE))
        self.add_value('IRCamera.frame_size', int(config.FULL_FRAME_SIZE))
        self.add_value('IRCamera.frame_dimx', int(config.FULL_FRAME_SHAPE[0]))
        self.add_value('IRCamera.frame_dimy', int(config.FULL_FRAME_SHAPE[1]))
        self.add_value('IRCamera.initialized', False)

    
    def add_array(self, name, array):
        self.shms[name] = shared_memory.SharedMemory(create=True, name=name, size=array.nbytes)
        self.arrs[name] = np.ndarray(array.shape, dtype=array.dtype, buffer=self.shms[name].buf)
        
        # Remplissage vectorisé (rapide, côté C) :
        self.arrs[name][:] = array
        #self.shms[name].close()  # ne détruit pas
        logger.info(f'added shared array {name} {array.shape}')

    def add_value(self, name, val):
        self.add_array(name, np.array([val,]))


    def __getitem__(self, name):
        return self.arrs[name]

    def __setitem__(self, name, value):
        self.arrs[name] = value


    def __del__(self):
        for ikey in self.shms:
            self.shms[ikey].close()
            self.shms[ikey].unlink()
            logger.info(f'removed shared memory {ikey}')

